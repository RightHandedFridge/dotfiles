- name: Setup
  hosts: localhost
  connection: local
  become: true
  gather_facts: true

  vars:
    remote_regular_user: "{{ ansible_env.SUDO_USER or ansible_user_id }}"

  tasks:
    - name: Install Pacman Packages
      ansible.builtin.pacman:
        name:
          # Build Tools
          - git
          - base-devel

          # Drivers
          - foomatic-db

          # Fonts
          - inter-font

          # Tools
          - android-tools
          - syncthing
          - fastfetch
          - tealdeer
          - usbutils
          - btop

          # DE
          - flatpak-kcm

          # GUI
          - alacritty
        state: present
        update_cache: true

    - name: Install flatpak packages
      community.general.flatpak:
        name:
            #Games
            - com.valvesoftware.Steam
            - org.vinegarhq.Sober
            - org.prismlauncher.PrismLauncher
            - com.heroicgameslauncher.hgl

            # Browser
            - dev.vencord.Vesktop
            - io.gitlab.librewolf-community

            #Tools
            - com.vscodium.codium
            - org.keepassxc.KeePassXC
            - org.libreoffice.LibreOffice
            - org.videolan.VLC
            - com.protonvpn.www

            #Creative
            - com.obsproject.Studio
            - org.kde.kdenlive
            - org.qbittorrent.qBittorrent
            - com.github.wwmm.easyeffects
            - com.github.PintaProject.Pinta
            - org.kde.krita

    # --- Install yay AUR Helper from source ---
    - name: Check if yay binary exists
      ansible.builtin.command: which yay
      register: yay_check
      ignore_errors: true
      changed_when: false # This command doesn't change system state

    - name: Set fact if yay exists
      ansible.builtin.set_fact:
        yay_exists: "{{ yay_check.rc == 0 }}"

    - name: Define temporary build directory for yay
      ansible.builtin.set_fact:
        yay_build_dir: "/tmp/yay_build_{{ ansible_facts['user_id'] }}"

    - name: Create yay build directory
      ansible.builtin.file:
        path: "{{ yay_build_dir }}"
        state: directory
        mode: '0755'
        owner: "{{ remote_regular_user }}"
        group: "{{ remote_regular_user }}"

    - name: Clone yay AUR repository
      ansible.builtin.git:
        repo: 'https://aur.archlinux.org/yay.git'
        dest: "{{ yay_build_dir }}"
        force: true
      become: false
      become_user: "{{ remote_regular_user }}"

    - name: Build and install yay
      ansible.builtin.command: makepkg -si --noconfirm
      args:
        chdir: "{{ yay_build_dir }}"
      become: false
      become_user: "{{ remote_regular_user }}"
    - name: Remove yay build directory
      ansible.builtin.file:
        path: "{{ yay_build_dir }}"
        state: absent
